<section class="container">
  <div class="page-header">
    <h1>Gerador de Exercícios Pedagógicos</h1>
    <p>Defina a série alvo e descreva a atividade para receber sugestões prontas para sala de aula.</p>
  </div>

  <div class="form-grid">
    <mat-form-field appearance="outline" class="serie-box">
      <mat-label>Série alvo</mat-label>
      <mat-select [(ngModel)]="serieSelecionada" placeholder="Selecione a série">
        <mat-option *ngFor="let serie of seriesDisponiveis" [value]="serie">{{ serie }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="prompt-box">
      <mat-label>Descreva o exercício desejado</mat-label>
      <textarea
        matInput
        rows="4"
        [(ngModel)]="promptUsuario"
        placeholder="Ex: Atividade sobre cores para Jardim 1 com objetivos e materiais"
      ></textarea>
    </mat-form-field>
  </div>

  <div class="actions">
    <button
      mat-raised-button
      color="primary"
      (click)="gerar()"
      [disabled]="carregando || !promptUsuario || !serieSelecionada"
    >
      {{ geracaoSucesso ? 'Gerar novamente' : 'Gerar Exercício' }}
    </button>
    <button
      *ngIf="geracaoSucesso && respostaIA"
      mat-stroked-button
      color="primary"
      [matMenuTriggerFor]="menuExportacao"
      [disabled]="carregando"
    >
      Exportar atividade
    </button>
  </div>
  <span
    #feedbackTrigger="matMenuTrigger"
    [matMenuTriggerFor]="feedbackMenu"
    class="feedback-popover-trigger"
    aria-hidden="true"
  ></span>
  <p *ngIf="!serieSelecionada || !promptUsuario" class="form-hint">
    Preencha a série alvo e descreva o exercício para liberar a geração.
  </p>

  <mat-menu #menuExportacao="matMenu">
    <button mat-menu-item (click)="exportarTxt()">Baixar .txt</button>
    <button mat-menu-item (click)="exportarPdf()">Baixar .pdf</button>
  </mat-menu>

  <div *ngIf="carregando" class="loading-state">
    <mat-progress-spinner diameter="36" mode="indeterminate"></mat-progress-spinner>
    <span>Gerando sugestões...</span>
  </div>

  <mat-card *ngIf="respostaIA" class="resposta-card">
    <mat-card-title>Exercício Sugerido:</mat-card-title>
    <mat-card-content>
      <div [innerHTML]="textoFormatado" class="markdown-content"></div>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="erroGeracao" class="error-card">
    <mat-card-title>Não foi possível gerar o exercício</mat-card-title>
    <mat-card-content>{{ erroGeracao }}</mat-card-content>
  </mat-card>

  <mat-menu
    #feedbackMenu="matMenu"
    panelClass="feedback-popover-panel"
    xPosition="before"
    yPosition="above"
    (closed)="feedbackPopoverAberto = false"
  >
    <div class="feedback-card" (click)="$event.stopPropagation()">
      <div class="feedback-header">
        <h3 class="feedback-title">Esse exercício foi útil para você?</h3>
        <button
          mat-icon-button
          type="button"
          class="close-popover"
          (click)="fecharFeedbackPopover()"
          aria-label="Fechar feedback"
        >
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="feedback-options">
        <button
          mat-stroked-button
          color="primary"
          type="button"
          class="feedback-option-button"
          [class.feedback-selected]="feedbackEscolha === 'util'"
          (click)="selecionarFeedback('util')"
        >
          Útil
        </button>
        <button
          mat-stroked-button
          color="primary"
          type="button"
          class="feedback-option-button"
          [class.feedback-selected]="feedbackEscolha === 'nao_util'"
          (click)="selecionarFeedback('nao_util')"
        >
          Não foi útil
        </button>
      </div>

      <mat-form-field appearance="outline" class="feedback-comment">
        <mat-label>Comentário (opcional)</mat-label>
        <textarea
          matInput
          rows="3"
          [(ngModel)]="feedbackComentario"
          placeholder="Conte o que funcionou ou o que pode melhorar."
        ></textarea>
      </mat-form-field>

      <div class="feedback-actions">
        <button
          mat-raised-button
          color="accent"
          type="button"
          (click)="enviarFeedback()"
          [disabled]="feedbackEnviando || feedbackEnviado || !feedbackEscolha"
        >
          {{ feedbackEnviando ? 'Enviando...' : 'Enviar feedback' }}
        </button>
        <span *ngIf="feedbackEnviado" class="feedback-status success">Obrigado pelo feedback!</span>
        <span *ngIf="feedbackErro" class="feedback-status error">{{ feedbackErro }}</span>
      </div>
    </div>
  </mat-menu>
</section>
